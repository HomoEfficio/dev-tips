# Redis Cluster 사용 시 주의 사항

## cluster, node, slot

- 클러스터는 여러 노드로 구성되고,
- 노드는 여러 슬롯을 포함한다.
- 레디스 클러스터의 총 슬롯 수는 16,384개
- 따라서 16,384개의 슬롯이 노드에 분배되고
- 여러 노드가 클러스터를 구성한다.


## 클러스터 전환

- 클러스터 구성 먼저 해두고 기존 standalone redis 데이터를 클러스터로 이관
- 클라우드 서비스에서 제공하는 데이터 마이그레이션 기능 사용

### 전환 전 준비 사항

- 클러스터는 키에 포함된 해시태그(`{}`로 감싸진 문자열)의 해시값 기준으로 slot에 분배하므로,
- mget, mset 처럼 여러 키에 대한 값을 한 번에 수행하는 명령은 클러스터 모드에서는 여러 slot에서 읽어오게 될 수 있으므로 문제가 될 수 있다.
  - RedisTemplate.multiGet()은 mget
  - RedisTemplate.multiSet()은 mset
  - RedisTemplate.multiSetIfAbsent()은 msetnx()
  - RedisTemplate.delete(Collection)도 여러키에 접근
- 따라서 위와 같은 코드는 클러스터 마이그레이션 전에 반복문 사용 등으로 전환해둬야 한다.

## 파이프라인

- 여러 명령을 한 번의 레디스 연결로 수행하는 파이프라인 기능은 connection 단위로 실행되므로
- 동일한 connection에서 실행할 수 있는 명령 모음만 실행 가능하다.
- 따라서 하나의 파이프라인에서는 동일한 노드로의 연결에서 실행할 수 있는 명령,
  - 결국에는 동일한 slot 에서 실행할 수 있는 명령 모음만 실행해야 한다.


